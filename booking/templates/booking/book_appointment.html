{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mt-5">
    <h1 class="text-center">Book Your Appointment</h1>

    <!-- Form -->
    <form id="booking-form" method="POST">
        {% csrf_token %}

        <!-- Service Selection -->
        <div class="mb-3">
            <label for="service" class="form-label">Select Service</label>
            <select id="service" name="service" class="form-select">
                <option value="">-- Choose a Service --</option>
                {% for service in services %}
                <option value="{{ service.id }}">{{ service.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Barber Selection -->
        <div class="container mt-4">
            <h2>Select Your Barber</h2>
            <div class="row text-center">
                {% for barber in barbers %}
                <div class="col-6 col-md-4 mb-4">
                    <button
                        type="button"
                        class="btn barber-button w-100 {% if barber.available_slots == 0 %}disabled{% endif %}"
                        data-id="{{ barber.id }}"
                        {% if barber.available_slots == 0 %}disabled{% endif %}
                    >
                        <div class="card text-center">
                            <img
                                src="{% static 'images/barber_default.webp' %}"
                                alt="{{ barber.name }}"
                                class="card-img-top rounded-circle mx-auto mt-3"
                            >
                            <div class="card-body">
                                <h5 class="card-title">{{ barber.name }}</h5>
                                <p class="card-text">{{ barber.specialization }}</p>
                                {% if barber.available_slots > 0 %}
                                <span class="badge bg-success">{{ barber.available_slots }} Slots Available</span>
                                {% else %}
                                <span class="badge bg-danger">Fully Booked</span>
                                {% endif %}
                            </div>
                        </div>
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Date Picker -->
        <div class="container mt-4">
            <h2>Select Date</h2>
            <div class="row row-cols-7 g-1">
                {% for day in calendar_days %}
                <div class="col text-center {% if day.month != current_month %}text-muted{% endif %}">
                    <button
                        type="button"
                        class="btn {% if day in available_dates %}btn-success{% else %}btn-light disabled{% endif %}"
                        data-date="{{ day }}"
                        {% if day not in available_dates %}disabled{% endif %}
                    >
                        {{ day.day }}
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Time Slot Selection -->
        <div id="time-slots" class="container mt-4">
            <h2>Select Time Slot</h2>
            <div class="row text-center">
                {% for slot in available_time_slots %}
                <div class="col-3">
                    <button
                        type="button"
                        class="btn btn-outline-primary time-slot-button"
                        data-time="{{ slot }}"
                    >
                        {{ slot }}
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="btn btn-primary mt-4 w-100">Confirm Booking</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const barberButtons = document.querySelectorAll('.barber-button');
        const dateButtons = document.querySelectorAll('[data-date]');
        const timeSlotsContainer = document.getElementById('time-slots');

        let selectedBarber = null;
        let selectedDate = null;

        // Barber selection
        barberButtons.forEach(button => {
            button.addEventListener('click', function () {
                barberButtons.forEach(btn => btn.classList.remove('btn-primary'));
                this.classList.add('btn-primary');
                selectedBarber = this.getAttribute('data-id');
                fetchAvailableDates();
            });
        });

        // Date selection
        dateButtons.forEach(button => {
            button.addEventListener('click', function () {
                dateButtons.forEach(btn => btn.classList.remove('btn-primary'));
                this.classList.add('btn-primary');
                selectedDate = this.getAttribute('data-date');
                fetchAvailableTimeSlots();
            });
        });

        // Fetch available dates based on the barber
        function fetchAvailableDates() {
            if (selectedBarber) {
                fetch(`/available_dates/?barber_id=${selectedBarber}`)
                    .then(response => response.json())
                    .then(data => {
                        dateButtons.forEach(button => {
                            const date = button.getAttribute('data-date');
                            if (data.available_dates.includes(date)) {
                                button.classList.remove('btn-light', 'disabled');
                                button.classList.add('btn-success');
                                button.disabled = false;
                            } else {
                                button.classList.add('btn-light', 'disabled');
                                button.classList.remove('btn-success');
                                button.disabled = true;
                            }
                        });
                    });
            }
        }

        // Fetch available time slots based on barber and date
        function fetchAvailableTimeSlots() {
            if (selectedBarber && selectedDate) {
                fetch(`/available_time_slots/?barber_id=${selectedBarber}&date=${selectedDate}`)
                    .then(response => response.json())
                    .then(data => {
                        timeSlotsContainer.innerHTML = '';
                        data.available_slots.forEach(slot => {
                            const button = document.createElement('button');
                            button.classList.add('btn', 'btn-outline-primary', 'time-slot-button', 'col-3', 'm-1');
                            button.textContent = slot;
                            button.setAttribute('data-time', slot);
                            button.addEventListener('click', function () {
                                document.querySelectorAll('.time-slot-button').forEach(btn => btn.classList.remove('btn-primary'));
                                this.classList.add('btn-primary');
                            });
                            timeSlotsContainer.appendChild(button);
                        });
                    });
            }
        }
    });
</script>
{% endblock %}
